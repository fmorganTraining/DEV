@IsTest
private class AOSFDCDesicionLogParserTest {
	
    @IsTest
    private static void testHappyPath() {
        String testData = '<?xml version="1.0" encoding="UTF-8"?><Root><AvokaSmartForm><formMetadata></formMetadata><Applicant><NewAccount><item><AccountGroupNumber /><AccountNumber>718600895</AccountNumber><MajorTypeCode>CK</MajorTypeCode><MinorTypeCode>CKBA</MinorTypeCode></item></NewAccount><Contact><Email>avokatest123@gmail.com</Email><LastName>Hansen</LastName><FirstName>Aaron</FirstName><DateOfBirth>1982-01-03</DateOfBirth><Ssn>599-99-1112</Ssn><MaskedSsn>1112</MaskedSsn><ApplicantPersona>member</ApplicantPersona><PersonNumber>273773</PersonNumber><Phone>2084661111</Phone><MobilePhone>2084662222</MobilePhone><WorkPhone>2089493333</WorkPhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingPostalCode>83221</MailingPostalCode><MailingCountry>USA</MailingCountry><MailingCountryCode>USA</MailingCountryCode><FiservAgreementIds><FiservAgreementIds>2258347</FiservAgreementIds></FiservAgreementIds><IDNumber>DB195346C</IDNumber><IDType>Salesforce Drivers License</IDType><IDIssueState>ID</IDIssueState><IDIssueDate>1988-07-06</IDIssueDate><IDExpiryDate>1988-07-06</IDExpiryDate></Contact></Applicant><AccountsFunding><FundJson>[{"AccountNumberTo":"718600895","FundAmount":500}]</FundJson><PropayPaymentType>ICCU</PropayPaymentType><AccountNumberFrom>709794192</AccountNumberFrom><TotalFundAmount>500</TotalFundAmount><UsingPropay>false</UsingPropay></AccountsFunding><BgFundWith>ICCU</BgFundWith><IsJointApplication>Yes</IsJointApplication><JointIsKnown>false</JointIsKnown><JointFirstName>Michelle</JointFirstName><JointLastName>Young</JointLastName><JointEmail>myoung@iccu.com</JointEmail><TriageFlow><ProductSelection><SelectedProductObject><mjaccttypcd>CK</mjaccttypcd><miaccttypcd>CKBA</miaccttypcd><active_start>2018-06-11T00:00:00.000Z</active_start><active_end>2038-01-01T00:00:00.000Z</active_end><product_info><display_name><en>Free Checking</en></display_name><product_description><en>With an Idaho Central FREE Checking Account, you will receive more perks and benefits than anywhere else!</en><es>Nuestro cuenta de cheques más popular para tramitar frecuentemente.</es></product_description><marketing_features><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></marketing_features><marketing_features><en>Free instant-issue Visa Check Card</en><es /></marketing_features><marketing_features><en>Free Mobile Banking</en><es /></marketing_features><marketing_features><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></marketing_features><marketing_features><en>Free access to over 30,000 ATMs nationwide</en><es /></marketing_features><marketing_features><en>Free Direct Deposit</en><es /></marketing_features><marketing_features><en>Control purchases on your Debit Card with CardControl</en><es /></marketing_features><other_product_features>overdraft_protection_eligible</other_product_features><other_product_features>check_ordering_eligible</other_product_features><eligibility><primary><min_age>18</min_age><min_dep>100</min_dep></primary><joint /></eligibility></product_info><category>6</category><dfDisplayName>Free Checking</dfDisplayName><dfDescription>With an Idaho Central FREE Checking Account, you will receive more perks and benefits than anywhere else!</dfDescription><dfExpanded>false</dfExpanded><dfFeatures><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></dfFeatures><dfFeatures><en>Free instant-issue Visa Check Card</en><es /></dfFeatures><dfFeatures><en>Free Mobile Banking</en><es /></dfFeatures><dfFeatures><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></dfFeatures><dfFeatures><en>Free access to over 30,000 ATMs nationwide</en><es /></dfFeatures><dfFeatures><en>Free Direct Deposit</en><es /></dfFeatures><dfFeatures><en>Control purchases on your Debit Card with CardControl</en><es /></dfFeatures><dfEligibilities><en>Minimum Age: 18</en></dfEligibilities><dfEligibilities><en>Minimum Deposit: $100</en></dfEligibilities><repeatMarketingFeatures><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></repeatMarketingFeatures><repeatMarketingFeatures><en>Free instant-issue Visa Check Card</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Mobile Banking</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free access to over 30,000 ATMs nationwide</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Direct Deposit</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Control purchases on your Debit Card with CardControl</en><es /></repeatMarketingFeatures><rptEligibilities><en>Minimum Age: 18</en></rptEligibilities><rptEligibilities><en>Minimum Deposit: $100</en></rptEligibilities><dfSelected>true</dfSelected><dfSelectedDisplayName>Free Checking</dfSelectedDisplayName></SelectedProductObject><MajorProductId>CK</MajorProductId><MinorProductId>CKBA</MinorProductId><YouthEligible>false</YouthEligible><SelectedProductInterestRate>0</SelectedProductInterestRate><JointEligible /></ProductSelection><ApplicantPersona>member</ApplicantPersona><NewMembership /><IsJointApplication>true</IsJointApplication><ClosestBranch><Success>true</Success><Error /><IccuBranch><Branch><Name>Blackfoot Branch</Name><Address>498 North Meridian, Blackfoot, ID 83221</Address><Phone>208-478-3300</Phone><HasATM>true</HasATM><ProductsServices><ProductsServices><Name>Checking</Name><Url>https://www.iccu.com/accounts/personal-checking-accounts/</Url></ProductsServices><ProductsServices><Name>Savings</Name><Url>https://www.iccu.com/accounts/personal-savings-accounts/</Url></ProductsServices><ProductsServices><Name>Visas</Name><Url>https://www.iccu.com/loans/visa-credit-cards/</Url></ProductsServices><ProductsServices><Name>Visa Rewards</Name><Url>https://www.iccu.com/visarewards/</Url></ProductsServices><ProductsServices><Name>Home Loans</Name><Url>https://www.iccu.com/loans/home-loans/</Url></ProductsServices><ProductsServices><Name>Auto &amp; RV Loans</Name><Url>https://www.iccu.com/loans/auto-rv-loans/</Url></ProductsServices><ProductsServices><Name>IRAs &amp; CDs</Name><Url>https://www.iccu.com/accounts/investments-planning/</Url></ProductsServices><ProductsServices><Name>Business Accounts &amp; Loans</Name><Url>https://www.iccu.com/accounts/?type=business</Url></ProductsServices><ProductsServices><Name>Student Accounts &amp; Loans</Name><Url>https://www.iccu.com/accounts/student-accounts/</Url></ProductsServices><ProductsServices><Name>Signature &amp; Secured Loans</Name><Url>https://www.iccu.com/loans/signature-secured-loans/</Url></ProductsServices><ProductsServices><Name>Credit Builder Loans</Name><Url>https://www.iccu.com/loans/credit-builder/</Url></ProductsServices><ProductsServices><Name>Youth Accounts</Name><Url>https://www.iccu.com/accounts/kids-accounts/</Url></ProductsServices></ProductsServices><Hours>Lobby Hours: M-F 9:00-6:00 Drive-Thru Hours: M-F 8:30-6:00 Saturday Hours: 9:00-3:00 (lobby &amp; drive-thru)</Hours><Geolocation><Latitude>43.1972055</Latitude><Longitude>-112.3557499</Longitude><ValidCoordinate>true</ValidCoordinate></Geolocation><Photo>https://www.iccu.com/inc/uploads/2016/03/Blackfoot-Credit-Union.jpg</Photo></Branch><Distance><Value>1901</Value><Text>1.2 mi</Text></Distance></IccuBranch></ClosestBranch><ChkBypassKBA /><MaskedEmail>************@gmail.com</MaskedEmail><JointPersonAge /><PrimaryApplicantAge /><Applicant><FirstName /><LastName /><Email /><Ssn /><Dob /><DriversLicenseNumber /><DriversLicenseState /><DriversLicenseIssueDate /><DriversLicenseExpiryDate /><CreditScore /><CreditReportDate /><PersonNumber /><MiddleName /></Applicant></TriageFlow><DepositOptions><OrderingChecks>Y</OrderingChecks><OverdraftProtectionChosen>1</OverdraftProtectionChosen><StatementsOptionChosen>eStatement</StatementsOptionChosen><DebitCardOptionChosen>N</DebitCardOptionChosen></DepositOptions><FATCA /><Checkbox>true</Checkbox><RbOverdraft>in for</RbOverdraft><RbDebitCard>pick up your new debit card</RbDebitCard><RbStatement>opted into eStatement</RbStatement><CreditCheckConsent>true</CreditCheckConsent><RbPreselect /><DebugIsJoint /><CheckboxTestMode /><SFMData><FormBundleMeta><DebugEmail>myoung@iccu.com</DebugEmail></FormBundleMeta><SystemProfile><FormCode>disclosures</FormCode><RequestLogKey>237c1135061a3489387b1ed4456e318a</RequestLogKey><DisplayMode>Entry</DisplayMode><RevisionNumber>2</RevisionNumber><TrackingCode>2C2STG9</TrackingCode><SubmissionNumber>86576</SubmissionNumber><SubmissionExpiryDate /><SubmitDateString /><FormDataServiceURL>https://test.iccu.avoka-transact.com/apps/servlet/FormDynamicDataServlet</FormDataServiceURL><Job><ReferenceNumber>274FZVH</ReferenceNumber><StepName>Product Form</StepName><Assignee>myoung@iccu.com</Assignee><AvailableRoutes>Default</AvailableRoutes><StepTasks><Task><StepName>Product Form</StepName><MenuLabel>Complete Deposit Products Application</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Deposit Products Application</TaskSubject><TaskMessage>Please Complete Deposit Products Application</TaskMessage><FormCompleted>true</FormCompleted><FormEditable>true</FormEditable><FormName>Deposit Products</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=a50459f7bdcdb2d7ef005c2180f44aca</FormURL><ReceiptURL>https://test.iccu.avoka-transact.com/apps/servlet/FormReceipt.pdf?submitKey=a50459f7bdcdb2d7ef005c2180f44aca&amp;renderMode=file</ReceiptURL><CurrentForm>false</CurrentForm></Task><Task><StepName>Product Form</StepName><MenuLabel>Complete Disclosures and Signatures form.</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Disclosures and Signatures form.</TaskSubject><TaskMessage>Please complete the Disclosures and Signatures form.</TaskMessage><FormCompleted>false</FormCompleted><FormEditable>true</FormEditable><FormName>Disclosures and Signatures</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=4fb26aaaa51eab6225c1766d466ddc63</FormURL><CurrentForm>true</CurrentForm></Task><Task><StepName>Product Form</StepName><MenuLabel>Complete Funding Application</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Funding Application</TaskSubject><TaskMessage>Please complete the Funding form.</TaskMessage><FormCompleted>false</FormCompleted><FormEditable>true</FormEditable><FormName>Accounts and Funding</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=13c4bfaeafd3b43b626647ccd4413c27</FormURL><CurrentForm>false</CurrentForm></Task></StepTasks></Job><SubmissionType>Submitted</SubmissionType><ReceiptNumber>2C2STG9</ReceiptNumber></SystemProfile><NarrativeMeta><CurrentPage /><PreviousPage /><NextPage>PgCompletion</NextPage><Action>forward</Action><PageWaitMessage /><PageVisibility>{"PgCompletion":"true","PgConfirmDetails":"true","PgFunding":"true","PgCreateEAccount":"false"}</PageVisibility><DisableSubmit>false</DisableSubmit><DisableSave>false</DisableSave><DisableBack>true</DisableBack><FatalError /><RedirectUrl /></NarrativeMeta></SFMData><TxtFnameIi_1>Aaron</TxtFnameIi_1><LastName>Hansen</LastName><DateOfBirth>1982-01-03</DateOfBirth><Membership>person</Membership><TitleIdv /><Verification><VerificationCode>661722</VerificationCode><VerificationMethod /></Verification><Address><Google><IsManualInput /></Google></Address><DdCountryPickerPI>US</DdCountryPickerPI><TxtUpdateEmail /><Docusignembeddedsigningceremonywidget /><TxtProdSelectValidationHolder>CKBA</TxtProdSelectValidationHolder><DdRbgChildCategories /><IsManualInput_2 /><PromoCode /><Triage><IsJointApplication>false</IsJointApplication><ApplicantPersona>unknown</ApplicantPersona><Applicant><PersonNumber>273773</PersonNumber><FirstName>Aaron</FirstName><LastName>Hansen</LastName><Email>avokatest123@gmail.com</Email><Phone>2084661111</Phone><WorkPhone>2089493333</WorkPhone><MobilePhone>2084662222</MobilePhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingCountry>USA</MailingCountry><MailingPostalCode>83221</MailingPostalCode><Ssn>599-99-1112</Ssn><DateOfBirth>1982-01-03</DateOfBirth><IDNumber /><Idtype /></Applicant><IdInfo /><Idv /><Mitek /><KBA /><EligibilityOptions /></Triage><DecisionLog>{"primaryApplicant":{"SFDC":{"everything":"","callStatus":"APPROVE","decision":"APPROVE","transactionKey":"04f1755201c758eb55bec756fb786972","trackingNumber":"274FZVH","svcDisplayName":"SFDC-Email Check"}},"jointApplicant":{},"txnStatus":"NOT SET"}</DecisionLog><PrimaryApplicant><IsJointApplication>false</IsJointApplication><ApplicantPersona>unknown</ApplicantPersona><Applicant><PersonNumber>273773</PersonNumber><FirstName>Aaron</FirstName><LastName>Hansen</LastName><Email>avokatest123@gmail.com</Email><Phone>2084661111</Phone><WorkPhone>2089493333</WorkPhone><MobilePhone>2084662222</MobilePhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingCountry>USA</MailingCountry><MailingPostalCode>83221</MailingPostalCode><Ssn>599-99-1112</Ssn><DateOfBirth>1982-01-03</DateOfBirth><IDNumber /><Idtype /></Applicant><IdInfo /><Idv /><Mitek /><KBA /><EligibilityOptions /></PrimaryApplicant></AvokaSmartForm></Root>';   
            
        XPath xpath = new XPath(testData);
        Dom.XmlNode decisionLogNode = xpath.findFirst('/Root/AvokaSmartForm/DecisionLog');
        String logText = decisionLogNode.getText();
        Map<String, Object> logPayload = (Map<String, Object>)JSON.deserializeUntyped(logText);
        Map<String, Object> primaryApplicant = (Map<String, Object>)logPayload.get('primaryApplicant');
        
        AOSFDCDesicionLogParser parser = new AOSFDCDesicionLogParser();
        AOApplicationInfo appInfo = new AOApplicationInfo();
        parser.parsePayload(primaryApplicant, appInfo);
        
        String systemName = parser.getSystemName();
        AOInteractionResult result = appInfo.systemInteractionResults.get(systemName);
        
        System.debug('System Name: ' + systemName);
        System.debug(result);
        
        List<String> errors = appInfo.errors;
            
        Integer expectedErrorCount = 0;
        Integer actualErrorCount = errors.size();
        System.assertEquals(expectedErrorCount, actualErrorCount, 'Error: ' + errors);
        
        System.assert(result != null);
        System.assert(result.state == AOInteractionResult.State.SUCCESS, 'Expected "state" to be "SUCCESS".');  
    }
    
    @IsTest
    private static void testFailedDecision() {
        String testData = '<?xml version="1.0" encoding="UTF-8"?><Root><AvokaSmartForm><formMetadata></formMetadata><Applicant><NewAccount><item><AccountGroupNumber /><AccountNumber>718600895</AccountNumber><MajorTypeCode>CK</MajorTypeCode><MinorTypeCode>CKBA</MinorTypeCode></item></NewAccount><Contact><Email>avokatest123@gmail.com</Email><LastName>Hansen</LastName><FirstName>Aaron</FirstName><DateOfBirth>1982-01-03</DateOfBirth><Ssn>599-99-1112</Ssn><MaskedSsn>1112</MaskedSsn><ApplicantPersona>member</ApplicantPersona><PersonNumber>273773</PersonNumber><Phone>2084661111</Phone><MobilePhone>2084662222</MobilePhone><WorkPhone>2089493333</WorkPhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingPostalCode>83221</MailingPostalCode><MailingCountry>USA</MailingCountry><MailingCountryCode>USA</MailingCountryCode><FiservAgreementIds><FiservAgreementIds>2258347</FiservAgreementIds></FiservAgreementIds><IDNumber>DB195346C</IDNumber><IDType>Salesforce Drivers License</IDType><IDIssueState>ID</IDIssueState><IDIssueDate>1988-07-06</IDIssueDate><IDExpiryDate>1988-07-06</IDExpiryDate></Contact></Applicant><AccountsFunding><FundJson>[{"AccountNumberTo":"718600895","FundAmount":500}]</FundJson><PropayPaymentType>ICCU</PropayPaymentType><AccountNumberFrom>709794192</AccountNumberFrom><TotalFundAmount>500</TotalFundAmount><UsingPropay>false</UsingPropay></AccountsFunding><BgFundWith>ICCU</BgFundWith><IsJointApplication>Yes</IsJointApplication><JointIsKnown>false</JointIsKnown><JointFirstName>Michelle</JointFirstName><JointLastName>Young</JointLastName><JointEmail>myoung@iccu.com</JointEmail><TriageFlow><ProductSelection><SelectedProductObject><mjaccttypcd>CK</mjaccttypcd><miaccttypcd>CKBA</miaccttypcd><active_start>2018-06-11T00:00:00.000Z</active_start><active_end>2038-01-01T00:00:00.000Z</active_end><product_info><display_name><en>Free Checking</en></display_name><product_description><en>With an Idaho Central FREE Checking Account, you will receive more perks and benefits than anywhere else!</en><es>Nuestro cuenta de cheques más popular para tramitar frecuentemente.</es></product_description><marketing_features><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></marketing_features><marketing_features><en>Free instant-issue Visa Check Card</en><es /></marketing_features><marketing_features><en>Free Mobile Banking</en><es /></marketing_features><marketing_features><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></marketing_features><marketing_features><en>Free access to over 30,000 ATMs nationwide</en><es /></marketing_features><marketing_features><en>Free Direct Deposit</en><es /></marketing_features><marketing_features><en>Control purchases on your Debit Card with CardControl</en><es /></marketing_features><other_product_features>overdraft_protection_eligible</other_product_features><other_product_features>check_ordering_eligible</other_product_features><eligibility><primary><min_age>18</min_age><min_dep>100</min_dep></primary><joint /></eligibility></product_info><category>6</category><dfDisplayName>Free Checking</dfDisplayName><dfDescription>With an Idaho Central FREE Checking Account, you will receive more perks and benefits than anywhere else!</dfDescription><dfExpanded>false</dfExpanded><dfFeatures><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></dfFeatures><dfFeatures><en>Free instant-issue Visa Check Card</en><es /></dfFeatures><dfFeatures><en>Free Mobile Banking</en><es /></dfFeatures><dfFeatures><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></dfFeatures><dfFeatures><en>Free access to over 30,000 ATMs nationwide</en><es /></dfFeatures><dfFeatures><en>Free Direct Deposit</en><es /></dfFeatures><dfFeatures><en>Control purchases on your Debit Card with CardControl</en><es /></dfFeatures><dfEligibilities><en>Minimum Age: 18</en></dfEligibilities><dfEligibilities><en>Minimum Deposit: $100</en></dfEligibilities><repeatMarketingFeatures><en>No Minimum balance required and no monthly fees</en><es>Tarjeta debito gratis</es></repeatMarketingFeatures><repeatMarketingFeatures><en>Free instant-issue Visa Check Card</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Mobile Banking</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Google Pay, Samsung Pay, and Apple Pay with Mobile Wallet</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free access to over 30,000 ATMs nationwide</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Free Direct Deposit</en><es /></repeatMarketingFeatures><repeatMarketingFeatures><en>Control purchases on your Debit Card with CardControl</en><es /></repeatMarketingFeatures><rptEligibilities><en>Minimum Age: 18</en></rptEligibilities><rptEligibilities><en>Minimum Deposit: $100</en></rptEligibilities><dfSelected>true</dfSelected><dfSelectedDisplayName>Free Checking</dfSelectedDisplayName></SelectedProductObject><MajorProductId>CK</MajorProductId><MinorProductId>CKBA</MinorProductId><YouthEligible>false</YouthEligible><SelectedProductInterestRate>0</SelectedProductInterestRate><JointEligible /></ProductSelection><ApplicantPersona>member</ApplicantPersona><NewMembership /><IsJointApplication>true</IsJointApplication><ClosestBranch><Success>true</Success><Error /><IccuBranch><Branch><Name>Blackfoot Branch</Name><Address>498 North Meridian, Blackfoot, ID 83221</Address><Phone>208-478-3300</Phone><HasATM>true</HasATM><ProductsServices><ProductsServices><Name>Checking</Name><Url>https://www.iccu.com/accounts/personal-checking-accounts/</Url></ProductsServices><ProductsServices><Name>Savings</Name><Url>https://www.iccu.com/accounts/personal-savings-accounts/</Url></ProductsServices><ProductsServices><Name>Visas</Name><Url>https://www.iccu.com/loans/visa-credit-cards/</Url></ProductsServices><ProductsServices><Name>Visa Rewards</Name><Url>https://www.iccu.com/visarewards/</Url></ProductsServices><ProductsServices><Name>Home Loans</Name><Url>https://www.iccu.com/loans/home-loans/</Url></ProductsServices><ProductsServices><Name>Auto &amp; RV Loans</Name><Url>https://www.iccu.com/loans/auto-rv-loans/</Url></ProductsServices><ProductsServices><Name>IRAs &amp; CDs</Name><Url>https://www.iccu.com/accounts/investments-planning/</Url></ProductsServices><ProductsServices><Name>Business Accounts &amp; Loans</Name><Url>https://www.iccu.com/accounts/?type=business</Url></ProductsServices><ProductsServices><Name>Student Accounts &amp; Loans</Name><Url>https://www.iccu.com/accounts/student-accounts/</Url></ProductsServices><ProductsServices><Name>Signature &amp; Secured Loans</Name><Url>https://www.iccu.com/loans/signature-secured-loans/</Url></ProductsServices><ProductsServices><Name>Credit Builder Loans</Name><Url>https://www.iccu.com/loans/credit-builder/</Url></ProductsServices><ProductsServices><Name>Youth Accounts</Name><Url>https://www.iccu.com/accounts/kids-accounts/</Url></ProductsServices></ProductsServices><Hours>Lobby Hours: M-F 9:00-6:00 Drive-Thru Hours: M-F 8:30-6:00 Saturday Hours: 9:00-3:00 (lobby &amp; drive-thru)</Hours><Geolocation><Latitude>43.1972055</Latitude><Longitude>-112.3557499</Longitude><ValidCoordinate>true</ValidCoordinate></Geolocation><Photo>https://www.iccu.com/inc/uploads/2016/03/Blackfoot-Credit-Union.jpg</Photo></Branch><Distance><Value>1901</Value><Text>1.2 mi</Text></Distance></IccuBranch></ClosestBranch><ChkBypassKBA /><MaskedEmail>************@gmail.com</MaskedEmail><JointPersonAge /><PrimaryApplicantAge /><Applicant><FirstName /><LastName /><Email /><Ssn /><Dob /><DriversLicenseNumber /><DriversLicenseState /><DriversLicenseIssueDate /><DriversLicenseExpiryDate /><CreditScore /><CreditReportDate /><PersonNumber /><MiddleName /></Applicant></TriageFlow><DepositOptions><OrderingChecks>Y</OrderingChecks><OverdraftProtectionChosen>1</OverdraftProtectionChosen><StatementsOptionChosen>eStatement</StatementsOptionChosen><DebitCardOptionChosen>N</DebitCardOptionChosen></DepositOptions><FATCA /><Checkbox>true</Checkbox><RbOverdraft>in for</RbOverdraft><RbDebitCard>pick up your new debit card</RbDebitCard><RbStatement>opted into eStatement</RbStatement><CreditCheckConsent>true</CreditCheckConsent><RbPreselect /><DebugIsJoint /><CheckboxTestMode /><SFMData><FormBundleMeta><DebugEmail>myoung@iccu.com</DebugEmail></FormBundleMeta><SystemProfile><FormCode>disclosures</FormCode><RequestLogKey>237c1135061a3489387b1ed4456e318a</RequestLogKey><DisplayMode>Entry</DisplayMode><RevisionNumber>2</RevisionNumber><TrackingCode>2C2STG9</TrackingCode><SubmissionNumber>86576</SubmissionNumber><SubmissionExpiryDate /><SubmitDateString /><FormDataServiceURL>https://test.iccu.avoka-transact.com/apps/servlet/FormDynamicDataServlet</FormDataServiceURL><Job><ReferenceNumber>274FZVH</ReferenceNumber><StepName>Product Form</StepName><Assignee>myoung@iccu.com</Assignee><AvailableRoutes>Default</AvailableRoutes><StepTasks><Task><StepName>Product Form</StepName><MenuLabel>Complete Deposit Products Application</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Deposit Products Application</TaskSubject><TaskMessage>Please Complete Deposit Products Application</TaskMessage><FormCompleted>true</FormCompleted><FormEditable>true</FormEditable><FormName>Deposit Products</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=a50459f7bdcdb2d7ef005c2180f44aca</FormURL><ReceiptURL>https://test.iccu.avoka-transact.com/apps/servlet/FormReceipt.pdf?submitKey=a50459f7bdcdb2d7ef005c2180f44aca&amp;renderMode=file</ReceiptURL><CurrentForm>false</CurrentForm></Task><Task><StepName>Product Form</StepName><MenuLabel>Complete Disclosures and Signatures form.</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Disclosures and Signatures form.</TaskSubject><TaskMessage>Please complete the Disclosures and Signatures form.</TaskMessage><FormCompleted>false</FormCompleted><FormEditable>true</FormEditable><FormName>Disclosures and Signatures</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=4fb26aaaa51eab6225c1766d466ddc63</FormURL><CurrentForm>true</CurrentForm></Task><Task><StepName>Product Form</StepName><MenuLabel>Complete Funding Application</MenuLabel><MenuCategory>Product Form</MenuCategory><TaskSubject>Complete Funding Application</TaskSubject><TaskMessage>Please complete the Funding form.</TaskMessage><FormCompleted>false</FormCompleted><FormEditable>true</FormEditable><FormName>Accounts and Funding</FormName><FormURL>https://test.iccu.avoka-transact.com/apps/secure/form.htm?submitKey=13c4bfaeafd3b43b626647ccd4413c27</FormURL><CurrentForm>false</CurrentForm></Task></StepTasks></Job><SubmissionType>Submitted</SubmissionType><ReceiptNumber>2C2STG9</ReceiptNumber></SystemProfile><NarrativeMeta><CurrentPage /><PreviousPage /><NextPage>PgCompletion</NextPage><Action>forward</Action><PageWaitMessage /><PageVisibility>{"PgCompletion":"true","PgConfirmDetails":"true","PgFunding":"true","PgCreateEAccount":"false"}</PageVisibility><DisableSubmit>false</DisableSubmit><DisableSave>false</DisableSave><DisableBack>true</DisableBack><FatalError /><RedirectUrl /></NarrativeMeta></SFMData><TxtFnameIi_1>Aaron</TxtFnameIi_1><LastName>Hansen</LastName><DateOfBirth>1982-01-03</DateOfBirth><Membership>person</Membership><TitleIdv /><Verification><VerificationCode>661722</VerificationCode><VerificationMethod /></Verification><Address><Google><IsManualInput /></Google></Address><DdCountryPickerPI>US</DdCountryPickerPI><TxtUpdateEmail /><Docusignembeddedsigningceremonywidget /><TxtProdSelectValidationHolder>CKBA</TxtProdSelectValidationHolder><DdRbgChildCategories /><IsManualInput_2 /><PromoCode /><Triage><IsJointApplication>false</IsJointApplication><ApplicantPersona>unknown</ApplicantPersona><Applicant><PersonNumber>273773</PersonNumber><FirstName>Aaron</FirstName><LastName>Hansen</LastName><Email>avokatest123@gmail.com</Email><Phone>2084661111</Phone><WorkPhone>2089493333</WorkPhone><MobilePhone>2084662222</MobilePhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingCountry>USA</MailingCountry><MailingPostalCode>83221</MailingPostalCode><Ssn>599-99-1112</Ssn><DateOfBirth>1982-01-03</DateOfBirth><IDNumber /><Idtype /></Applicant><IdInfo /><Idv /><Mitek /><KBA /><EligibilityOptions /></Triage><DecisionLog>{"primaryApplicant":{"SFDC":{"everything":"","callStatus":"APPROVE","decision":"FAIL","transactionKey":"04f1755201c758eb55bec756fb786972","trackingNumber":"274FZVH","svcDisplayName":"SFDC-Email Check"}},"jointApplicant":{},"txnStatus":"NOT SET"}</DecisionLog><PrimaryApplicant><IsJointApplication>false</IsJointApplication><ApplicantPersona>unknown</ApplicantPersona><Applicant><PersonNumber>273773</PersonNumber><FirstName>Aaron</FirstName><LastName>Hansen</LastName><Email>avokatest123@gmail.com</Email><Phone>2084661111</Phone><WorkPhone>2089493333</WorkPhone><MobilePhone>2084662222</MobilePhone><MailingStreet>15122 Wagner Road</MailingStreet><MailingStreet2 /><MailingCity>Blackfoot</MailingCity><MailingState>ID</MailingState><MailingCountry>USA</MailingCountry><MailingPostalCode>83221</MailingPostalCode><Ssn>599-99-1112</Ssn><DateOfBirth>1982-01-03</DateOfBirth><IDNumber /><Idtype /></Applicant><IdInfo /><Idv /><Mitek /><KBA /><EligibilityOptions /></PrimaryApplicant></AvokaSmartForm></Root>';

        XPath xpath = new XPath(testData);
        Dom.XmlNode decisionLogNode = xpath.findFirst('/Root/AvokaSmartForm/DecisionLog');
        String logText = decisionLogNode.getText();
        Map<String, Object> logPayload = (Map<String, Object>)JSON.deserializeUntyped(logText);
        Map<String, Object> primaryApplicant = (Map<String, Object>)logPayload.get('primaryApplicant');

        AOSFDCDesicionLogParser parser = new AOSFDCDesicionLogParser();
        AOApplicationInfo appInfo = new AOApplicationInfo();
        parser.parsePayload(primaryApplicant, appInfo);

        String systemName = parser.getSystemName();
        AOInteractionResult result = appInfo.systemInteractionResults.get(systemName);
        
        List<String> errors = appInfo.errors;
        
        Integer expectedErrorCount = 0;
        Integer actualErrorCount = errors.size();
        System.assertEquals(expectedErrorCount, actualErrorCount, 'Error: ' + errors);

        System.assert(result != null);
        System.assert(result.state == AOInteractionResult.State.ERROR, 'Expected "state" to be "ERROR".');  
    }
}